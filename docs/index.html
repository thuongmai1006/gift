<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interactive Birthday Cake</title>
  <style>
    :root {
      --cake: #f3b399;
      --frosting: #fff6fb;
      --plate: #e8eef6;
      --candle: #ffd24d;
      --wick: #333;
      --flame1: #ffcc00;
      --flame2: #ff7a00;
      --bg: #fafbff;
      --sprinkle1: #6c63ff;
      --sprinkle2: #ff5da2;
      --sprinkle3: #2ec4b6;
      --smoke: rgba(160,160,160,.8);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, sans-serif;
      background: radial-gradient(1000px 600px at 50% -200px, #eef3ff, var(--bg));
      display: grid; place-items: center;
    }

    .scene { text-align: center; padding: 24px 12px 40px; }
    h1 { margin: 0 0 120px; font-size: clamp(20px, 5vw, 32px); color: #30374a; }

    .cake-wrap { position: relative; display: inline-block; transform-origin: top center; transition: transform .25s ease; }
    .plate { width: 300px; height: 18px; background: var(--plate); border-radius: 999px; margin: 20px auto 0; box-shadow: inset 0 4px 10px rgba(0,0,0,0.08); }

    .cake { display: flex; flex-direction: column-reverse; align-items: center; filter: drop-shadow(0 12px 18px rgba(0,0,0,.12)); }
    .layer { height: 20px; background: linear-gradient(#f6c0a9, var(--cake)); border: 2px solid #e2a28c; border-radius: 8px; position: relative; overflow: hidden; margin-top: -4px; opacity: 0; transform: translateY(-80px); }
    .layer.top { border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; overflow: visible; }

    /* Drop-in animation */
    @keyframes drop-in { 0% { transform: translateY(-120px) scaleY(1.05); opacity: 0; } 70% { transform: translateY(8px); opacity: 1; } 85% { transform: translateY(-4px); } 100% { transform: translateY(0); opacity: 1; } }
    .layer.show { animation: drop-in .55s cubic-bezier(.2,.8,.2,1) forwards; }

    .frosting { position: absolute; top: -5px; left: 0; right: 0; height: 16px; background: var(--frosting); border-bottom: 2px solid #efd9e8; border-top-left-radius: 6px; border-top-right-radius: 6px; box-shadow: inset 0 -2px 0 #f0e5ef; }
    .sprinkles { position: absolute; inset: 4px 6px auto 6px; display: flex; gap: 6px; flex-wrap: wrap; }
    .sprinkle { width: 8px; height: 3px; border-radius: 2px; background: var(--c, var(--sprinkle1)); transform: rotate(var(--r,0deg)); }

    .candle { width: 12px; height: 36px; background: repeating-linear-gradient(90deg, #ffd24d 0 6px, #ffe89a 6px 12px); border-radius: 4px; border: 2px solid #e3b930; position: absolute; left: 50%; transform: translateX(-50%); top: -40px; display: grid; place-items: center; z-index: 2; }
    .wick { width: 2px; height: 8px; background: var(--wick); margin-top: -4px; }

    .flame { position: absolute; top: -18px; left: 50%; transform: translateX(-50%); width: 24px; height: 34px; background: radial-gradient(circle at 50% 55%, var(--flame1) 0 35%, var(--flame2) 36% 70%, transparent 71% 100%); border-radius: 14px 14px 12px 12px / 22px 22px 12px 12px; animation: flicker 1s infinite alternate; filter: drop-shadow(0 0 12px rgba(255,170,0,.8)); transform-origin: 50% 100%; }
    @keyframes flicker { 0%{ transform:translateX(-50%) scale(.92) rotate(-2deg);} 100%{ transform:translateX(-50%) scale(1.06) rotate(2deg);} }
    .flame.out { opacity: 0; animation: none; filter: none; }

    .smoke { position: absolute; top: -18px; left: 50%; width: 6px; height: 6px; background: var(--smoke); border-radius: 50%; opacity: .8; transform: translateX(-50%) translateY(0) scale(1); animation: puff 1.2s ease-out forwards; }
    @keyframes puff { to { opacity: 0; transform: translateX(-50%) translateY(-24px) scale(2.2); } }

    .controls { margin-top: 14px; display: inline-flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; }
    .controls input[type="number"] { width: 90px; padding: 6px; }
    .controls button { padding: 8px 12px; border: 0; border-radius: 10px; background: #30374a; color: #fff; cursor: pointer; }
    .hint { font-size: 12px; color: #374151; margin-top: 6px; opacity: .9; }
  </style>
</head>
<body>
  <main class="scene">
    <h1>ðŸŽ‚ <span id="title">Happy Birthday!</span></h1>
    <div class="cake-wrap">
      <div class="cake"></div>
      <div class="plate"></div>
    </div>

    <div class="controls">
      <label for="ageInput">How old are you?</label>
      <input id="ageInput" type="number" min="1" max="120" step="1" placeholder="e.g., 7" />
      <button id="setAgeBtn" type="button">Build Cake</button>
      <button id="relightBtn" type="button" title="Relight the candle">Relight</button>
    </div>
    <div class="hint"></div>
  </main>

  <script>
    (function(){
      const cakeEl = document.querySelector('.cake');
      const titleEl = document.getElementById('title');
      const inputEl = document.getElementById('ageInput');
      const btnEl = document.getElementById('setAgeBtn');
      const relightBtn = document.getElementById('relightBtn');
      let currentFlame = null;
      let stopMic = null; // function to stop audio stream

      function ordinal(n){ const s=["th","st","nd","rd"], v=n%100; return n+(s[(v-20)%10]||s[v]||s[0]); }
      function clampAge(n){ n=parseInt(n,10); if(isNaN(n)) return 1; return Math.max(1, Math.min(n, 30)); }

      function makeSprinkle(color,rot){ const s=document.createElement('div'); s.className='sprinkle'; s.style.setProperty('--c',color); s.style.setProperty('--r',rot+'deg'); return s; }
      function addFrostingAndSprinkles(layer){
        const frosting=document.createElement('div'); frosting.className='frosting'; layer.appendChild(frosting);
        const spr=document.createElement('div'); spr.className='sprinkles';
        const colors=['var(--sprinkle1)','var(--sprinkle2)','var(--sprinkle3)'];
        for(let i=0;i<8;i++) spr.append(makeSprinkle(colors[i%3], (Math.random()*50-25)|0));
        layer.appendChild(spr);
      }
      function buildTopCandle(layer){
        const candle=document.createElement('div'); candle.className='candle';
        const wick=document.createElement('div'); wick.className='wick';
        const flame=document.createElement('div'); flame.className='flame'; flame.setAttribute('role','button'); flame.setAttribute('aria-label','Blow out candle');
        candle.append(wick,flame); layer.appendChild(candle);
        return flame;
      }

      function fitToViewport(layerCount){
        const LAYER_H = 20, OVERLAP = 4, CANDLE_HEADROOM = 100;
        const effectivePerLayer = LAYER_H - OVERLAP; // 16
        const cakeHeight = Math.max(0, layerCount) * effectivePerLayer + CANDLE_HEADROOM;
        const reserved = 220; // header + controls
        const available = Math.max(200, window.innerHeight - reserved);
        const scale = Math.min(1, available / cakeHeight);
        document.querySelector('.cake-wrap').style.transform = `scale(${scale})`;
      }

      function renderCake(age){
        const a=clampAge(age);
        cakeEl.innerHTML='';
        currentFlame = null;

        const baseWidth=220, step=8;
        for(let i=0;i<a;i++){
          const layer=document.createElement('div');
          layer.className='layer' + (i===a-1 ? ' top' : '');
          const width=baseWidth - i*step; // top smaller
          layer.style.width=width+'px';
          addFrostingAndSprinkles(layer);
          if(i===a-1){ currentFlame = buildTopCandle(layer); attachBlowInteractions(currentFlame); }
          cakeEl.appendChild(layer);
          // trigger staggered drop animation
          requestAnimationFrame(() => {
            const delay = i * 90; // ms between layers
            setTimeout(() => {
              layer.classList.add('show');
              layer.style.animationDelay = '0ms';
            }, delay);
          });
        }
        titleEl.textContent='Happy '+ordinal(a)+' Birthday!';
      
      }

      // ==== Blow interactions ====
      function blowOut(){
        if(!currentFlame || currentFlame.classList.contains('out')) return;
        currentFlame.classList.add('out');
        const smoke=document.createElement('div');
        smoke.className='smoke';
        currentFlame.parentElement.appendChild(smoke);
        setTimeout(()=> smoke.remove(), 1400);
        if(typeof stopMic==='function'){ stopMic(); stopMic=null; }
      }

      function relight(){
        if(!currentFlame) return;
        currentFlame.classList.remove('out');
        enableMicBlow(currentFlame);
      }

      function attachBlowInteractions(flame){
        flame.addEventListener('click', blowOut);
        enableMicBlow(flame);
        relightBtn.onclick = relight;
      }

      function enableMicBlow(){
        if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const src = ctx.createMediaStreamSource(stream);
          const analyser = ctx.createAnalyser(); analyser.fftSize = 2048; src.connect(analyser);
          const data = new Uint8Array(analyser.fftSize);
          let rafId;
          function tick(){
            analyser.getByteTimeDomainData(data);
            let sum=0; for(let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum += v*v; }
            const rms = Math.sqrt(sum/data.length);
            if(rms > 0.09){ blowOut(); }
            rafId = requestAnimationFrame(tick);
          }
          tick();
          stopMic = function(){ cancelAnimationFrame(rafId); stream.getTracks().forEach(t=>t.stop()); if(ctx.state!=='closed') ctx.close(); };
        }).catch(()=>{});
      }

      function askAndRender(){ const ans=prompt('How old are you?'); if(ans===null) return; inputEl.value=ans; renderCake(ans); }
      btnEl.addEventListener('click',()=>renderCake(inputEl.value));
      window.addEventListener('load',askAndRender);
      window.addEventListener('resize',()=>{ const a=parseInt(inputEl.value||'0',10); if(a>0) fitToViewport(a); });
    })();
  </script>
</body>
</html>
